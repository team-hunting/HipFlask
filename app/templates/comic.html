{% extends 'base.html' %}

{% block title %} Comic Scraper {% endblock %}

{% block body %}

<div class="min-vw-100 vh-100 d-flex" style="background-color: #eee;">
    <div class="mx-auto my-auto" style="max-width: 75%; min-width: 75%;" >
    <div>


        Enter a readcomiconline.li URL in the box. <br/> 
        Press "Info" to retrive data about the comic. <br/> <br/>
        Example: <br/> 
        https://readcomiconline.li/Comic/Sandman-Presents-Lucifer <br/> <br/>
        <div class="input-group mb-3">
            <div class="input-group-prepend">
              <button class="btn btn-outline-secondary" id="infobutton" type="button">Info</button>
            </div>
            <input type="text" id="comicurl" class="form-control" placeholder="" aria-label="" aria-describedby="basic-addon1">
        </div>
        
        <div class="form-outline">
            <label for="urldisplay">
                <span class="text-muted">URL:</span> 
              </label>

            <input
              class="form-control"
              id="urldisplay"
              type="text"
              placeholder="https://readcomiconline.li/Comic/Sandman-Presents-Lucifer"
              aria-label="Comic URL"
              readonly /> 
            <label class="form-label" for="urldisplay"></label>
          </div>

        <div class="form-outline">
            <label for="titledisplay">
                <span class="text-muted">Title:</span> 
              </label>

            <input
              class="form-control"
              id="titledisplay"
              type="text"
              placeholder="Sandman-Presents-Lucifer"
              aria-label="Comic Title"
              readonly /> 
            <label class="form-label" for="titledisplay"></label>
          </div>

        <div class="form-outline">
            <label for="singleissuedisplay">
                <span class="text-muted">Single Issue Link Provided?</span> 
              </label>

            <input
                class="form-control"
                id="singleissuedisplay"
                type="text"
                placeholder="No"
                aria-label="Comic Single Issue"
                readonly /> 
            <label class="form-label" for="singleissuedisplay"></label>
        </div>

        <button id="getissuebutton">PRESS ME TO GET ISSUES</button>

    </div>
  </div>
</div>


<script type="text/javascript">

let infobutton = document.getElementById("infobutton");
let urlbox = document.getElementById("comicurl");
let urldisplay = document.getElementById("urldisplay");
let titledisplay = document.getElementById("titledisplay");
let singleissuedisplay = document.getElementById("singleissuedisplay");

let url = "{{ url_for('comicInfo') }}";

infobutton.addEventListener('click', (e) => {
    let body = "https://readcomiconline.li/Comic/Sandman-Presents-Lucifer";

    if (urlbox.value == "") {
      console.log("You need to enter a URL... Selecting default")
      body = {"url": "https://readcomiconline.li/Comic/Sandman-Presents-Lucifer"};
    }
    else {
      body = {"url": urlbox.value};
    } 

    let requestOptions = {
        body: JSON.stringify(body),
        headers: {
            "Content-Type": "application/json"
        },
        method: "POST"
    }

    fetch(url, requestOptions).then(
        function(response) {
            return response.json();
    }).then(function(result) {
        urldisplay.value = body['url']
        titledisplay.value = result['title']
        singleissuedisplay.value = result['singleissue'] ? "Yes" : "No"
    }).catch(function(err) {
        console.log(err);
    });
})

let issueUrl = "{{ url_for('issueInfo') }}";
let issuebutton = document.getElementById("getissuebutton");

issuebutton.addEventListener('click', (e) => {

let body = {
  "url": urlbox.value == "" ? "https://readcomiconline.li/Comic/Sandman-Presents-Lucifer" : urlbox.value
};

console.log(body)

let requestOptions = {
    body: JSON.stringify(body),
    headers: {
        "Content-Type": "application/json"
    },
    method: "POST"
}

fetch(issueUrl, requestOptions).then(
    function(response) {
      console.log(response)
      return response.json();
}).then(function(result) {
    //TODO: 
    //for issue in result['issues'] 
    //Add "&readType=1" to issue Link 
    //If they've ticked an HQ box, add "&quality=hq" as well
    //display issue[0]  -- Issue Title
    //display issue[1]  -- Issue Link
    //display button to begin scraping single issue
    //display button to begin scraping All
    console.log(result)
}).catch(function(err) {
    console.log(err);
});

})

// Scraping button:
// On click, document.queryselect all elements with issue links stored in them
// foreach element:
// fetch to api with URL 
// When fetch completes, generate that many IMG elements on page send the first link to the API for scraping images

</script>


{% endblock %}
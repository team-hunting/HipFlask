{% extends 'base.html' %}

{% block title %} Comic Scraper {% endblock %}

{% block body %}

<div class="min-vw-100 vh-100 d-flex" style="background-color: #eee;">
    <div class="mx-auto my-auto" style="max-width: 75%; min-width: 75%;" id="comicdiv" >
    <div>


        Enter a readcomiconline.li URL in the box. <br/> 
        Press "Info" to retrive data about the comic. <br/> <br/>
        Example: <br/> 
        https://readcomiconline.li/Comic/Sandman-Presents-Lucifer <br/> <br/>
        <div class="input-group mb-3">
            <div class="input-group-prepend">
              <button class="btn btn-outline-secondary" id="infobutton" type="button">Info</button>
            </div>
            <input type="text" id="comicurl" class="form-control" placeholder="" aria-label="" aria-describedby="basic-addon1">
        </div>
        
        <div class="form-outline">
            <label for="urldisplay">
                <span class="text-muted">URL:</span> 
              </label>

            <input
              class="form-control"
              id="urldisplay"
              type="text"
              placeholder="https://readcomiconline.li/Comic/Sandman-Presents-Lucifer"
              aria-label="Comic URL"
              readonly /> 
            <label class="form-label" for="urldisplay"></label>
          </div>

        <div class="form-outline">
            <label for="titledisplay">
                <span class="text-muted">Title:</span> 
              </label>

            <input
              class="form-control"
              id="titledisplay"
              type="text"
              placeholder="Sandman-Presents-Lucifer"
              aria-label="Comic Title"
              readonly /> 
            <label class="form-label" for="titledisplay"></label>
          </div>

        <div class="form-outline">
            <label for="singleissuedisplay">
                <span class="text-muted">Single Issue Link Provided?</span> 
              </label>

            <input
                class="form-control"
                id="singleissuedisplay"
                type="text"
                placeholder="No"
                aria-label="Comic Single Issue"
                readonly /> 
            <label class="form-label" for="singleissuedisplay"></label>
        </div>

        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="displayimages">
          <label class="form-check-label" for="displayimages">Display Images on this page after scraping?</label>
        </div>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="hqimages">
          <label class="form-check-label" for="hqimages">Scrape high quality images where available?</label>
        </div>
        <br/>

        <div id="scrapedIssues"></div>

        <br/>
        <div>Please be aware that this script waits 15 seconds in between scraping issues. This is to prevent readcomiconline.li from hitting us with a CAPTCHA.</div>
        <br/>
        
        <button id="getissuebutton">PRESS ME TO GET ISSUES</button> 
        <!-- <button id="printimglinks">LOG ALLIMAGES TO CONSOLE (DEV BUTTON)</button> -->
        <br/>

    </div>
  </div>
</div>


<script type="text/javascript">

let infobutton = document.getElementById("infobutton");
let urlbox = document.getElementById("comicurl");
let urldisplay = document.getElementById("urldisplay");
let titledisplay = document.getElementById("titledisplay");
let singleissuedisplay = document.getElementById("singleissuedisplay");

let url = "{{ url_for('comicInfo') }}";

infobutton.addEventListener('click', (e) => {
    let body = "https://readcomiconline.li/Comic/Sandman-Presents-Lucifer";

    if (urlbox.value == "") {
      console.log("You need to enter a URL... Selecting default")
      body = {"url": "https://readcomiconline.li/Comic/Sandman-Presents-Lucifer"};
    }
    else {
      body = {"url": urlbox.value};
    } 

    let requestOptions = {
        body: JSON.stringify(body),
        headers: {
            "Content-Type": "application/json"
        },
        method: "POST"
    }

    fetch(url, requestOptions).then(
        function(response) {
            return response.json();
    }).then(function(result) {
        urldisplay.value = body['url']
        titledisplay.value = result['title']
        singleissuedisplay.value = result['singleissue'] ? "Yes" : "No"
    }).catch(function(err) {
        console.log(err);
    });
})

let issueUrl = "{{ url_for('issueInfo') }}";
let issuebutton = document.getElementById("getissuebutton");

let allImageLinks = {"links":[]};

issuebutton.addEventListener('click', (e) => {

  let displayImagesOnPage = document.getElementById('displayimages').checked;

  let urlval = urlbox.value == "" ? "https://readcomiconline.li/Comic/Sandman-Presents-Lucifer" : urlbox.value
  let body = {
    "url": urlval
  };

  console.log(body)

  let requestOptions = {
      body: JSON.stringify(body),
      headers: {
          "Content-Type": "application/json"
      },
      method: "POST"
  }

  fetch(issueUrl, requestOptions).then(
      function(response) {
        console.log(response)
        return response.json();
  }).then(async function(result) {
      console.log(result)
      console.log(result['issues'])
      console.log(result['issues'].length)
      for (let i = 0; result['issues'].length > i; i++) {
        issueLink = result['issues'][i][1]
        issueTitle = result['issues'][i][0]
        console.log(`Beginning scrape of ${issueTitle} at ${issueLink}`)
        let info_section = document.createElement('div')
        info_section.setAttribute('id',`${result['title']}_${i}`);
        info_section.innerHTML = `Beginning scrape of ${issueTitle} at ${issueLink}`
        document.getElementById("comicdiv").appendChild(info_section);
        // Send issuelink to the api
        await getIssueHtml(issueLink).then(function(response) {
          console.log(`Response: ${response}`)
          console.log(response['imageLinks'])
          let imglinks = response['imageLinks']
          
          allImageLinks['links'].push(imglinks)

          // Create an "Issue Download" button
          createDownloadIssueButton(i, issueTitle);

          // for each image:
          if (displayImagesOnPage) {
            for (let i = 0; i < imglinks.length; i++) {
              displayImage(imglinks[i])
            }
          }
          
          
        }) 

        console.log("Sleeping for 15 seconds...");
        // SLEEP FOR 15 seconds before iterating again
        await new Promise(r => setTimeout(r, 15000));
      }
  }).catch(function(err) {
      console.log(err);
  });

})

function displayImage(imageUrl) {
  // TODO: stick images inside divs that resize based on viewport dimensions
  let image_section = document.createElement('div')
  let image_link = document.createElement('img')
  image_link.src = imageUrl
  image_section.appendChild(image_link)
  document.getElementById("comicdiv").appendChild(image_section);
}

let issueImagesUrl = "{{ url_for('scrapeIssue') }}";

async function getIssueHtml(issueLink) {

  let hqimages = document.getElementById('hqimages').checked;

  let requestOptions = {
        body: JSON.stringify({"issueLink":issueLink,"hq":hqimages}),
        headers: {
            "Content-Type": "application/json"
        },
        method: "POST"
    }

  let imageLinks = await fetch(issueImagesUrl, requestOptions).then(
        function(response) {
          //console.log(response)
            return response.json();
  }).catch(function(err) {
      console.log(err);
  });

  console.log("imagelinks returned ", imageLinks)
  return imageLinks
} 

// let showlinksbutton = document.getElementById("printimglinks");
// showlinksbutton.addEventListener('click', (e) => {
//   console.log("allImageLinks ", allImageLinks)
// })

function createDownloadIssueButton(issueNumber, issueTitle) {
  const button = document.createElement('button');
  const br = document.createElement('br');
  button.innerHTML = `Download ${issueTitle} - May take some time, be patient!`
  button.onclick = () => {downloadIssue(issueNumber, issueTitle)}
  document.getElementById("scrapedIssues").appendChild(button);
  document.getElementById("scrapedIssues").appendChild(br);
}

let issueDownloadUrl = "{{ url_for('downloadIssue') }}";
function downloadIssue(issueNumber, issueTitle) {
  // get comic title from issue link
  let links = allImageLinks['links'][issueNumber]; // this is an array of strings
  let title = getComicTitle();
  console.log("TITLE: " + title);

  let body = {"links":links,"title":title,"issueTitle":issueTitle}

  let requestOptions = {
        body: JSON.stringify(body),
        headers: {
            "Content-Type": "application/json"
        },
        method: "POST"
    }

    fetch(issueDownloadUrl, requestOptions).then(
        function(response) {
          console.log(response);
          
          return response.blob();

    }).then(function(response) {

          const newBlob = new Blob([response]);
          const blobUrl = window.URL.createObjectURL(newBlob);

          const link = document.createElement('a');
          link.href = blobUrl;
          let filename = getComicTitle() + "-" + issueTitle + ".cbz"
          link.setAttribute('download', `${filename}`);
          document.body.appendChild(link);
          link.click();
          link.parentNode.removeChild(link);

          // clean up Url
          window.URL.revokeObjectURL(blobUrl);

    }).catch(function(err) {
        console.log(err);
    });

}

function getComicTitleFromIssueLink(issuelink) {
  // https://readcomiconline.li/Comic/Sandman-Presents-Lucifer/Issue-3?id=37198
  let title = issuelink.replace("https://readcomiconline.li/Comic/", "");
  let titleArray = title.split("/");
  title = titleArray[0];
  console.log("TITLE DETECTED: " + title);
  return title;
}

function getComicTitle() {
  let title = urlbox.value.replace("https://readcomiconline.li/Comic/", "");
  if (title.slice(-1) === "/") {
    return title.slice(0,title.length -1)
  } else {
    return title
  }
}

</script>


{% endblock %}